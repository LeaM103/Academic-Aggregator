<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Academic Aggregator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:24px;background:#f7f9fc}
    .container{max-width:900px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .search-row{display:flex;gap:8px;margin-bottom:12px}
    input{flex:1;padding:8px}
    button{padding:8px 12px}
    .result{border-bottom:1px solid #eee;padding:10px 0}
    .muted{color:#666;font-size:0.9em}
  </style>
</head>
<body>
  <div class="container">
    <h1>Academic Aggregator</h1>
    <div class="search-row">
      <input id="q" placeholder="Search books (e.g. machine learning)" />
      <button id="searchBtn">Search</button>
    </div>
    <div id="status" class="muted">Enter a query and click Search.</div>
    <div id="results"></div>
    <hr/>
    <div class="muted">Demo helper: <a href="/whoami" target="_blank">/whoami</a></div>
  </div>

<script>
async function doSearch(q){
  const status = document.getElementById('status');
  const results = document.getElementById('results');
  results.innerHTML = '';
  status.textContent = 'Searching...';
  try{
    const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    if (!res.ok) {
      const body = await res.json().catch(()=>null);
      throw new Error(body && body.error ? body.error : 'Search failed');
    }
    const data = await res.json();
    const books = data.openLibrary || [];
    if (books.length === 0) {
      status.textContent = 'No results found.';
      return;
    }
    status.textContent = `Found ${books.length} result(s).`;
    books.forEach(b=>{
      const div = document.createElement('div');
      div.className = 'result';
      div.innerHTML = `<strong>${escapeHtml(b.title)}</strong> <div class="muted">${(b.authors && b.authors.length>0)?escapeHtml(b.authors.join(', ')):'Unknown author'}${b.year?(' â€” '+b.year):''}</div>`;
      results.appendChild(div);
    });
  } catch(err){
    console.error('Search error:', err);
    status.textContent = 'Search error: ' + (err.message || err);
  }
}

function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const q = document.getElementById('q').value.trim();
  if (!q) { document.getElementById('status').textContent = 'Please type a search term.'; return; }
  doSearch(q);
});
document.getElementById('q').addEventListener('keypress', e=>{ if (e.key==='Enter') document.getElementById('searchBtn').click(); });
</script>
</body>
</html>
